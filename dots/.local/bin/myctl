#!/usr/bin/env bash
#   __  __        ____ _____ _
#  |  \/  |_   _ / ___|_   _| |
#  | |\/| | | | | |     | | | |
#  | |  | | |_| | |___  | | | |___
#  |_|  |_|\__, |\____| |_| |_____|
#         |___/
#
#  MyDE Controller - Control various functions of MyDE


# ======================== Config ===========================

LOG_LEVEL=1
MYDE_DIR="$HOME/MyDE"
LIB_DIR="$HOME/.local/lib/myctl"
ROFI_CONF_DIR="$HOME/.config/rofi/conf"
KEYBINDS_FILE="$MYDE_DIR/wiki/docs/user-guide/keybinds.md"

#========================== Main Logic =========================

export MYDE_DIR LIB_DIR ROFI_CONF_DIR KEYBINDS_FILE LOG_LEVEL THIS_PATH

THIS_PATH="$(realpath "${BASH_SOURCE[0]}")"

# Dictionaries for SubCommands
declare -A sub_cmds

source "$LIB_DIR"/_utils.sh


[[ "$#" -eq 0 ]] && {
    self help
    exit 1
}

case "$1" in

    help|'-h'|--help)
        sub_cmds=(
            [cmd]="myde"
            [set]="Set configuration options (not yet implemented)"
            [show]="Show various utility dialougs"
            [get]="Retrieve info about current system config."
            [reload]="Reload MyDE configuration"
        )
        help_menu
        ;;

    # ==================== Get ====================
    get)
        shift # $1 = arg2
        case "$1" in
            help)
                sub_cmds=(
                    [cmd]="get"
                    [desktop-file]="Get desktop file path of an application"
                    [desktop-filename]="Get desktop file name of an application"
                    [theme]="Get current theme of MyDE or specific components"
                )
                help_menu
                ;;
            desktop-file)
                shift
                import_lib "get-desktop-file.sh"
                get-desktop-file "$1"
                ;;
            desktop-filename)
                shift
                import_lib "get-desktop-file.sh"
                get-desktop-file -n "$1"
                ;;
            cursor)
                shift
                case "$1" in
                    help)
                        sub_cmds=(
                            [cmd]="get cursor"
                            [name]="get current cursor theme name."
                            [size]="get current cursor size."
                        )
                        help_menu
                        ;;
                    theme)
                        import_lib "gtk-utils.sh"
                        get-gtk-cursor-theme
                        ;;
                    size)
                        import_lib "gtk-utils.sh"
                        get-gtk-cursor-size
                        ;;
                    ""|*)
                        invld_cmd "$1" && self get cursor help
                        exit 1
                        ;;
                esac
                ;;
            theme)
                shift
                sub_cmds=(
                    [cmd]="get theme"
                    [rofi]="get current rofi color theme."
                    [gtk]="get current gtk color theme."
                    [qt]="get current qt color theme. (not yet implemented)"
                )
                case "$1" in
                    help)
                        help_menu
                        ;;
                    rofi)
                        import_lib "rofi-utils.sh"
                        get-rofi-theme
                        ;;
                    gtk)
                        import_lib "gtk-utils.sh"
                        get-gtk-theme
                        ;;
                    qt|kde)
                        log.nyi   # TODO
                        ;;
                    ""|*)
                        invld_cmd "$1" && self get theme help
                        exit 1
                        ;;
                esac
                ;;
            ""|*)
                invld_cmd "$1" && self get help
                exit 1
                ;;
        esac
        ;;

    # ==================== set ====================
    set)
        shift
        case "$1" in
            help)
                sub_cmds=(
                    [cmd]="set"
                    [theme]="set theme for entire myde or specific components."
                )
                help_menu
                ;;
            theme)
                shift # $1 = arg3
                case "$1" in
                    help)
                        sub_cmds=(
                            [cmd]="set theme"
                            [rofi]="set rofi color theme."
                            [gtk]="set gtk color theme."
                        )
                        help_menu
                        ;;
                    rofi)
                        shift
                        import_lib "rofi-utils.sh"
                        set-rofi-theme "$1"
                        ;;
                    gtk)
                        shift
                        import_lib "gtk-utils.sh"
                        set-gtk-theme "$1"
                        ;;
                    ""|*)
                        invld_cmd "$1" && self set theme help
                        exit 1
                        ;;
                esac
                ;;
            ""|*)
                invld_cmd "$1" && self set help
                exit 1
                ;;
        esac
        ;;

    # ==================== show ====================
    show)
        shift
        case "$1" in
            help)
                sub_cmds=(
                    [cmd]="show"
                    [keybinds]="show keybinds hint window."
                    [powermenu]="show power menu window."
                )
                help_menu
                ;;
            keybinds)
                import_lib "keybinds-menu.sh"
                show-keybinds-menu -kf "$KEYBINDS_FILE" -t "$ROFI_CONF_DIR/keybinds-menu.rasi"
                ;;
            powermenu)
                import_lib "power-menu.sh"
                show-power-menu -t "$ROFI_CONF_DIR/power-menu.rasi"
                ;;
            ""|*)
                invld_cmd "$1" && self show help
                exit 1
                ;;
        esac
        ;;

    # ==================== reload ====================
    reload)
        shift
        case "$1" in
            help)
                sub_cmds=(
                    [cmd]="reload"
                )
                help_menu
                ;;
            "")
                hyprctl reload > /dev/null
                log.success "myde configuration reloaded."
                ;;
            *)
                invld_cmd "$1" && self help
                exit 1
                ;;
        esac
        ;;

    # ==================== default ====================
    ""|*)
        invld_cmd "$1" && self help
        exit 1
        ;;
esac
